<div class="flex flex-col h-[400px] bg-gray-800/50 rounded-xl border border-gray-700 shadow-inner">
  <div class="p-4 border-b border-gray-700 flex items-center justify-between">
    <h3 class="text-xl font-semibold text-purple-400">Refine with AI Chat</h3>
    @if (isLoading()) {
      <div class="flex items-center text-teal-400 text-sm">
        <div class="animate-spin rounded-full h-4 w-4 border-2 border-teal-400 border-t-transparent mr-2"></div>
        Generating response...
      </div>
    }
  </div>

  <!-- Chat Messages -->
  <div #chatMessagesContainer class="flex-grow overflow-y-auto p-4 space-y-4">
    @if (isDisabled()) {
      <div class="text-center text-gray-500 p-4 border border-dashed border-gray-700 rounded-lg">
        <p class="font-medium">Generate an initial Next.js project first to start chatting!</p>
      </div>
    } @else if (chatHistory().length === 0) {
      <div class="text-center text-gray-500 p-4">
        <p class="text-sm">Your initial Next.js project has been generated. Now, tell the AI how you'd like to refine it!</p>
        <p class="text-xs mt-1">e.g., "Make the hero section more vibrant", "Change the primary font to Inter", "Add more details to the 'About' section."</p>
      </div>
    }
    @for (message of chatHistory(); track $index) {
      <div [class]="message.role === 'user' ? 'flex justify-end' : 'flex justify-start'">
        <div [class]="message.role === 'user' ? 'bg-purple-600 text-white rounded-lg p-3 max-w-[75%] shadow-md' : 'bg-gray-700 text-gray-200 rounded-lg p-3 max-w-[75%] shadow-md border border-gray-600'">
          <p class="font-semibold text-sm mb-1">{{ message.role === 'user' ? 'You' : 'AI' }}</p>
          <div [class]="message.role === 'model' ? 'whitespace-pre-wrap break-words font-mono text-sm text-teal-300' : 'whitespace-pre-wrap break-words text-sm'">
            {{ message.text }}
          </div>
        </div>
      </div>
    }
    @if (errorMessage()) {
      <div class="flex justify-center">
        <div class="bg-red-900/20 border border-red-700 text-red-400 px-4 py-3 rounded-lg max-w-[75%] text-sm">
          <p class="font-semibold mb-1">Error:</p>
          <p>{{ errorMessage() }}</p>
        </div>
      </div>
    }
  </div>

  <!-- Chat Input -->
  <div class="p-4 border-t border-gray-700 flex gap-2">
    <input
      [formControl]="chatInput"
      (keyup.enter)="sendMessage()"
      type="text"
      placeholder="Type your message to refine the Next.js project..."
      class="flex-grow p-3 border border-gray-600 rounded-lg focus:ring-purple-500 focus:border-purple-500 transition duration-300 ease-in-out hover:border-purple-400 shadow-sm bg-gray-700 text-gray-200"
      [disabled]="isLoading() || isDisabled()"
    >
    <button
      (click)="sendMessage()"
      class="px-5 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition duration-300 ease-in-out shadow-md"
      [disabled]="chatInput.invalid || isLoading() || isDisabled()"
    >
      Send
    </button>
  </div>
</div>